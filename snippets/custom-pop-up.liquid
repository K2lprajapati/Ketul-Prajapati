<div class="product-popup hidden">
  <div class="popup-content">
    <span class="close-popup">&times;</span>
    <!-- Product Details -->
    <div class="product-info">
      <img src="{{ product.featured_image | img_url: 'large' }}" alt="{{ product.title }}">
      <h2>{{ product.title }}</h2>
      <p>{{ product.description | strip_html | truncate: 100 }}</p>

      <!-- Variant Selectors -->
      <div class="variant-selectors">
        {% assign option_names = product.options | downcase %}

        {% if option_names contains 'color' %}
          <label>Choose Color:</label>
          <div class="color-variants">
            {% assign color_variants = product.variants | map: 'option1' | uniq %}
            {% for color in color_variants %}
              {% assign variant = product.variants | where: 'option1', color | first %}
              {% assign color_swatch = variant.featured_image | default: '' %}
              <div
                class="color-pill"
                data-color="{{ color }}"
                style="background-color: {{ color | downcase }}; border-left: 4px solid {{ color | downcase }};"
              ></div>
            {% endfor %}
          </div>
        {% endif %}

        {% if option_names contains 'size' %}
          <label for="size-select">Choose Size:</label>
          <select id="size-select">
            {% assign size_variants = product.variants | map: 'option2' | uniq %}
            {% for size in size_variants %}
              <option value="{{ size }}">{{ size }}</option>
            {% endfor %}
          </select>
        {% endif %}
      </div>
      <!-- Add to Cart Button -->
      <button class="add-to-cart" data-product-id="{{ product.id }}">Add to Cart</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const popup = document.querySelector(".product-popup");
    const openPopupBtn = document.querySelector(".open-popup");
    const closePopupBtn = document.querySelector(".close-popup");
    const addToCartBtn = document.querySelector(".add-to-cart");
    const colorPills = document.querySelectorAll(".color-pill");
    const sizeSelect = document.querySelector("#size-select");

    let selectedColor = "";

    // Open Popup
    openPopupBtn.addEventListener("click", function() {
      popup.classList.remove("hidden");
    });

    // Close Popup
    closePopupBtn.addEventListener("click", function() {
      popup.classList.add("hidden");
    });

    // Select Color
    colorPills.forEach(pill => {
      pill.addEventListener("click", function() {
        colorPills.forEach(p => p.classList.remove("selected"));
        this.classList.add("selected");
        selectedColor = this.getAttribute("data-color");
      });
    });

    // Find the Correct Variant Based on Selected Color and Size
    function findVariantId(productVariants, selectedColor, selectedSize) {
      let variantId = null;
      productVariants.forEach(variant => {
        if (variant.option1 === selectedColor && variant.option2 === selectedSize) {
          variantId = variant.id;
        }
      });
      return variantId;
    }

    // Add to Cart Function
    // addToCartBtn.addEventListener("click", function() {
    //   let productId = addToCartBtn.dataset.productId;
    //   let selectedSize = sizeSelect.value;

    //   if (!selectedColor || !selectedSize) {
    //     alert("Please select both color and size.");
    //     return;
    //   }

    //   fetch(/products/${productId}.json)
    //     .then(response => response.json())
    //     .then(data => {
    //       let productVariants = data.product.variants;
    //       let variantId = findVariantId(productVariants, selectedColor, selectedSize);

    //       if (!variantId) {
    //         alert("Invalid selection.");
    //         return;
    //       }

    //       // Add to Cart API Call
    //       fetch('/cart/add.js', {
    //         method: 'POST',
    //         headers: { 'Content-Type': 'application/json' },
    //         body: JSON.stringify({ quantity: 1, id: variantId })
    //       })
    //       .then(response => response.json())
    //       .then(data => {
    //         alert("Product added to cart!");

    //         // Redirect to Cart Page
    //         window.location.href = "/cart";

    //         // Update Cart Drawer (if enabled)
    //         fetch('/cart.js')
    //           .then(response => response.json())
    //           .then(cartData => {
    //             if (document.querySelector("cart-drawer")) {
    //               document.querySelector("cart-drawer").dispatchEvent(new Event("cart:updated"));
    //             }
    //           });
    //       });
    //     });
    // });
  });
</script>
