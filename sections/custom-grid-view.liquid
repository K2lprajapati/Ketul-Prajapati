{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div class="section-{{ section.id }}-padding">
  <div class="{{ section.settings.section-checkbox }}">
    <div class="custom-section-product">
      <div class="custom-section-text">
        <h2>{{ section.settings['section-heading-text'] }}</h2>
      </div>

      <div class="custom-product-grid" id="section-{{ section.id }}">
        {% for block in section.blocks %}
          {% assign product = all_products[block.settings['custom-product']] %}

          {% style %}
            #block-{{ block.id }} .open-popup {
              position: absolute;
              top: {{ block.settings.position_top }}%;
              right: {{ block.settings.position_right }}%;
            }
          {% endstyle %}

          <div class="product-img-wrapper" id="block-{{ block.id }}" data-product-handle="{{ product.handle }}">
            {{ product.featured_image | image_url: width: 433, height: 444 | image_tag: class: 'custom-product-img open-popup', data-product-id: product.id }}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Popup -->
<div class="product-popup hidden">
  <div class="popup-content">
    <span class="close-popup">&times;</span>
    <div class="product-info">
      <img class="popup-product-img" src="" alt="Product Image">
      <h2 class="popup-product-title"></h2>
      <p class="popup-product-description"></p>

      <!-- Variant Selectors -->
      <div class="variant-selectors">
        <label for="size-select">Choose Size:</label>
        <select id="size-select"></select>
      </div>

      <button class="add-to-cart" data-product-id="">Add to Cart</button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const popup = document.querySelector(".product-popup");
    const closePopupBtn = document.querySelector(".close-popup");
    const productImgWrappers = document.querySelectorAll(".product-img-wrapper");

    productImgWrappers.forEach(wrapper => {
      wrapper.addEventListener("click", function () {
        const productHandle = this.getAttribute("data-product-handle");

        fetch(`/products/${productHandle}.json`)
          .then(response => response.json())
          .then(data => {
            const product = data.product;

            document.querySelector(".popup-product-img").src = product.images[0].src;
            document.querySelector(".popup-product-title").textContent = product.title;
            document.querySelector(".popup-product-description").textContent = product.body_html.replace(/(<([^>]+)>)/gi, "").substring(0, 100);
            document.querySelector(".add-to-cart").setAttribute("data-product-id", product.variants[0].id);

            let sizeSelect = document.querySelector("#size-select");
            sizeSelect.innerHTML = "";
            let sizes = [...new Set(product.variants.map(v => v.option2))];

            sizes.forEach(size => {
              let option = document.createElement("option");
              option.value = size;
              option.textContent = size;
              sizeSelect.appendChild(option);
            });

            popup.classList.remove("hidden");
          });
      });
    });

    closePopupBtn.addEventListener("click", function () {
      popup.classList.add("hidden");
    });

    document.querySelector(".add-to-cart").addEventListener("click", function () {
      let productId = this.getAttribute("data-product-id");
      let selectedSize = document.querySelector("#size-select").value;

      fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ quantity: 1, id: productId })
      })
      .then(response => response.json())
      .then(() => {
        alert("Product added to cart!");
        window.location.href = "/cart";
      });
    });
  });
</script>
